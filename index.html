<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control - Spectrum UI</title>
    <style>
        /* --- ESTILOS VISUALES BASE --- */
        :root {
            --bg-app: #f0f2f5; 
            --bg-panel: #ffffff; 
            --text-main: #1c1e21;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-hover: 0 12px 24px rgba(0,0,0,0.15);
            --radius: 12px; 
            --accent: #2980b9;
            --font-stack: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; font-family: var(--font-stack); background-color: var(--bg-app); 
            color: var(--text-main); height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* ANIMACIONES */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes swapPulse {
            0% { transform: scale(1); opacity: 1; }
            40% { transform: scale(0.85); opacity: 0.6; }
            60% { transform: scale(0.85); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulse-led {
            0% { transform: scale(0.95); opacity: 0.7; box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); }
            70% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 6px rgba(241, 196, 15, 0); }
            100% { transform: scale(0.95); opacity: 0.7; box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

        /* BARRA SUPERIOR */
        .toolbar { 
            flex: 0 0 auto; display: flex; gap: 15px; align-items: center; 
            padding: 12px 25px; background: var(--bg-panel); 
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); z-index: 100;
            animation: fadeInUp 0.4s ease-out;
        }
        .brand { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: -0.5px; }
        .brand span { color: var(--accent); }

        .search-box { flex: 1; position: relative; max-width: 450px; }
        .search-box input { 
            width: 100%; padding: 10px 15px 10px 40px; border-radius: 25px; 
            border: 1px solid #dce0e5; background: var(--bg-app); color: var(--text-main); 
            font-size: 0.9rem; transition: all 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }
        .search-box input:focus { border-color: var(--accent); background: var(--bg-panel); box-shadow: 0 4px 12px rgba(41, 128, 185, 0.15); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.5; width: 16px; transition: 0.3s; }
        .search-box input:focus + .search-icon { opacity: 1; color: var(--accent); }
        .search-tip { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--accent); opacity: 0.7; pointer-events: none; font-weight: 600; }

        .actions { display: flex; gap: 12px; margin-left: auto; align-items: center; }
        
        /* LED STATUS */
        .status-container { display: flex; align-items: center; gap: 8px; margin-right: 5px; padding: 6px 12px; background: #f8f9fa; border-radius: 20px; border: 1px solid #e9ecef; }
        .status-led {
            width: 10px; height: 10px; border-radius: 50%; background-color: #ccc;
            transition: all 0.3s ease; position: relative;
        }
        .status-text { font-size: 0.7rem; font-weight: 600; color: #7f8c8d; transition: color 0.3s; white-space: nowrap; }

        .status-led.online { background-color: #2ecc71; box-shadow: 0 0 6px #2ecc71; }
        .status-led.offline { background-color: #e74c3c; box-shadow: 0 0 6px #e74c3c; }
        .status-led.syncing { background-color: #f1c40f; animation: pulse-led 1.5s infinite; }

        /* --- BOTONES PROFESIONALES --- */
        .btn { 
            padding: 9px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); filter: brightness(0.95); }
        
        /* Botón Nube (Tipo Badge/Píldora) */
        .btn-cloud { 
            background: linear-gradient(to bottom, #ffffff, #f8f9fa); 
            color: #495057; 
            border-color: #dce0e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        } 
        .btn-cloud:hover { background: linear-gradient(to bottom, #f8f9fa, #e9ecef); border-color: #cdd4da; }
        .btn-cloud.saving { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        
        .cloud-icon.spinning { animation: spin 1s linear infinite; display: inline-block; }

        /* Botón Primario (Bloquear/Editar) */
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent), #1f6391); 
            color: white; 
            box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 6px 15px rgba(41, 128, 185, 0.4), inset 0 1px 0 rgba(255,255,255,0.3); 
        }
        .btn-primary.active { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        /* GRID */
        .dashboard-grid { 
            flex: 1; padding: 20px; display: grid; 
            grid-template-columns: repeat(6, 1fr); grid-auto-rows: minmax(110px, auto); 
            gap: 15px; overflow-y: auto; overflow-x: hidden; padding-bottom: 40px;
        }

        .card { 
            position: relative; border-radius: var(--radius); padding: 15px; 
            box-shadow: var(--shadow-card); cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
            user-select: none; overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.5); background: var(--bg-panel);
            opacity: 0; transform: translateY(20px);
            animation: fadeInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        
        /* Retrasos de entrada */
        .card:nth-child(1) { animation-delay: 0.05s; } .card:nth-child(2) { animation-delay: 0.07s; }
        .card:nth-child(3) { animation-delay: 0.09s; } .card:nth-child(4) { animation-delay: 0.11s; }
        .card:nth-child(5) { animation-delay: 0.13s; } .card:nth-child(6) { animation-delay: 0.15s; }
        .card:nth-child(7) { animation-delay: 0.17s; } .card:nth-child(8) { animation-delay: 0.19s; }
        .card:nth-child(9) { animation-delay: 0.21s; } .card:nth-child(10) { animation-delay: 0.23s; }
        .card:nth-child(11) { animation-delay: 0.25s; } .card:nth-child(12) { animation-delay: 0.27s; }
        .card:nth-child(13) { animation-delay: 0.29s; } .card:nth-child(14) { animation-delay: 0.31s; }
        .card:nth-child(15) { animation-delay: 0.33s; } .card:nth-child(16) { animation-delay: 0.35s; }
        .card:nth-child(17) { animation-delay: 0.37s; } .card:nth-child(18) { animation-delay: 0.39s; }
        .card:nth-child(19) { animation-delay: 0.41s; } .card:nth-child(20) { animation-delay: 0.43s; }
        .card:nth-child(21) { animation-delay: 0.45s; } .card:nth-child(22) { animation-delay: 0.47s; }
        .card:nth-child(23) { animation-delay: 0.49s; } .card:nth-child(24) { animation-delay: 0.51s; }

        .card:hover:not(.editing) { transform: translateY(-6px) scale(1.02); box-shadow: var(--shadow-hover); z-index: 10; }
        .card:active:not(.editing) { transform: scale(0.98); }
        
        .card.dragging { opacity: 0.4; transform: scale(0.9); border: 2px dashed #999; }
        .card.drag-target { transform: scale(1.05); box-shadow: 0 0 0 3px var(--accent); z-index: 20; }
        .card.swapping { animation: swapPulse 0.4s ease-in-out forwards; }

        .card-content { 
            font-size: 0.75rem; line-height: 1.4; font-weight: 600; color: #444;
            height: 100%; pointer-events: none; white-space: pre-wrap; transition: opacity 0.3s;
        }
        .card.dimmed { opacity: 0.08; transform: scale(0.95); filter: grayscale(1) blur(1px); pointer-events: none; }
        
        .card.editing { 
            cursor: text; border: 2px dashed #bdc3c7 !important; 
            background: #f9f9f9 !important; box-shadow: none !important; transform: none !important;
        }
        .card.editing .card-content { pointer-events: auto; opacity: 1; color: #000; }
        
        .settings-btn { 
            position: absolute; bottom: 8px; right: 8px; cursor: pointer; display: none; 
            background: white; border-radius: 50%; width: 24px; height: 24px; 
            align-items: center; justify-content: center; font-size: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .settings-btn:hover { transform: rotate(90deg) scale(1.1); background: var(--accent); color: white;}
        .card.editing .settings-btn { display: flex; animation: popIn 0.3s; }

        /* --- NUEVA PALETA DE COLORES EXTENDIDA (14 Colores) --- */
        /* Clásicos */
        .c-blue { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #0d47a1; }
        .c-green { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #1b5e20; }
        .c-purple { background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #4a148c; }
        .c-orange { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #e65100; }
        .c-red { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: #b71c1c; }
        .c-dark { background: linear-gradient(135deg, #37474f, #263238); color: #eceff1; }
        .c-gray { background: linear-gradient(135deg, #ffffff, #f5f5f5); color: #455a64; }
        /* Nuevos */
        .c-teal { background: linear-gradient(135deg, #e0f2f1, #b2dfdb); color: #00695c; }
        .c-pink { background: linear-gradient(135deg, #fce4ec, #f8bbd0); color: #880e4f; }
        .c-indigo { background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #283593; }
        .c-lime { background: linear-gradient(135deg, #f9fbe7, #dcedc8); color: #558b2f; }
        .c-amber { background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ff6f00; }
        .c-brown { background: linear-gradient(135deg, #efebe9, #d7ccc8); color: #4e342e; }
        .c-lavender { background: linear-gradient(135deg, #ede7f6, #d1c4e9); color: #512da8; }


        /* RIPPLE */
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple 0.6s linear; background-color: rgba(0, 0, 0, 0.05); pointer-events: none; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* TOAST */
        .toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px); 
            background: #2d3436; color: white; padding: 12px 24px; border-radius: 50px; 
            font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            opacity: 0; transition: all 0.4s; z-index: 300; pointer-events: none; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* MENU COLORES (Ajustado para 14 colores) */
        #colorMenu { 
            display: none; position: fixed; z-index: 200; background: var(--bg-panel); 
            padding: 18px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); 
            grid-template-columns: repeat(5, 1fr); gap: 12px; border: 1px solid rgba(0,0,0,0.05);
            animation: popIn 0.3s;
        }
        .swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .swatch:hover { transform: scale(1.15); box-shadow: 0 5px 10px rgba(0,0,0,0.15); border-color: rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <header class="toolbar">
        <div class="brand">Control<span>PRO</span></div>
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" id="searchInput" placeholder="Filtrar respuestas..." oninput="filterCards()">
            <span class="search-tip">Ctrl + F / ESC</span>
        </div>
        <div class="actions">
            <div class="status-container" title="Estado de conexión">
                <div id="statusLed" class="status-led"></div>
                <span id="statusLabel" class="status-text">...</span>
            </div>

            <button class="btn btn-cloud" id="cloudBtn" onclick="syncToCloud()" title="Sincronización Automática Activa">
                <span class="cloud-icon">☁️</span> <span id="cloudText">Nube OK</span>
            </button>
            
            <button class="btn btn-primary" id="editBtn" onclick="toggleEditMode()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                <span id="btnText">Bloqueado</span>
            </button>
        </div>
    </header>

    <div class="dashboard-grid" id="grid">
        <div class="card c-blue" draggable="true" id="c01"><div class="card-content">Realiza seguimiento a su ticket. / Se verifica que aún está en proceso...</div></div>
        <div class="card c-blue" draggable="true" id="c02"><div class="card-content">Solicita respuesta / Se verifica que ya figura como expirado...</div></div>
        <div class="card c-orange" draggable="true" id="c03"><div class="card-content">Solicita estado de solicitud XXXXXXXX...</div></div>
        <div class="card c-purple" draggable="true" id="c04"><div class="card-content">Requiere atención de IT Services...</div></div>
        <div class="card c-purple" draggable="true" id="c05"><div class="card-content">Se solicita evidencia del caso...</div></div>
        <div class="card c-blue" draggable="true" id="c06"><div class="card-content">Ticket no expirado (Variante 2)...</div></div>

        <div class="card c-blue" draggable="true" id="c07"><div class="card-content">Ticket expirado (Variante 2)...</div></div>
        <div class="card c-dark" draggable="true" id="c08"><div class="card-content">Generar ticket CRM evaluación...</div></div>
        <div class="card c-dark" draggable="true" id="c09"><div class="card-content">Derivar a Zendesk (SLA informado)...</div></div>
        <div class="card c-green" draggable="true" id="c10"><div class="card-content">Estimado, agradeceré revisar este caso...</div></div>
        <div class="card c-dark" draggable="true" id="c11"><div class="card-content">Opción SLA Excedido...</div></div>
        <div class="card c-purple" draggable="true" id="c12"><div class="card-content">Tipifica: CRM Intermitente...</div></div>

        <div class="card c-red" draggable="true" id="c13"><div class="card-content">No responde > Fin comunicación.</div></div>
        <div class="card c-red" draggable="true" id="c14"><div class="card-content">No contesta > Fin comunicación.</div></div>
        <div class="card c-red" draggable="true" id="c15"><div class="card-content">No contesta > Corta llamada.</div></div>
        <div class="card c-red" draggable="true" id="c16"><div class="card-content">No Rellamada (Alta Demanda).</div></div>
        <div class="card c-red" draggable="true" id="c17"><div class="card-content">No deriva - Sin Opción.</div></div>
        <div class="card c-red" draggable="true" id="c18"><div class="card-content">No deriva - Corta llamada.</div></div>

        <div class="card c-red" draggable="true" id="c19"><div class="card-content">No deriva - Molesto.</div></div>
        <div class="card c-gray" draggable="true" id="c20"><div class="card-content">Casilla vacía...</div></div>
        <div class="card c-gray" draggable="true" id="c21"><div class="card-content">Casilla vacía...</div></div>
        <div class="card c-gray" draggable="true" id="c22"><div class="card-content">Casilla vacía...</div></div>
        <div class="card c-gray" draggable="true" id="c23"><div class="card-content">Casilla vacía...</div></div>
        <div class="card c-gray" draggable="true" id="c24"><div class="card-content">Casilla vacía...</div></div>
    </div>

    <div id="toast" class="toast">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" color="#2ecc71"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span>Copiado</span>
    </div>
    <div id="overlay" style="display:none; position:fixed; inset:0; z-index:150; background: rgba(0,0,0,0.05); backdrop-filter: blur(2px);" onclick="closeColorMenu()"></div>
    
    <div id="colorMenu">
        <div class="swatch" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb)" onclick="setColor('c-blue')" title="Azul"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb)" onclick="setColor('c-teal')" title="Turquesa"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9)" onclick="setColor('c-green')" title="Verde"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f9fbe7, #dcedc8)" onclick="setColor('c-lime')" title="Lima"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2)" onclick="setColor('c-orange')" title="Naranja"></div>
        
        <div class="swatch" style="background: linear-gradient(135deg, #fff8e1, #ffecb3)" onclick="setColor('c-amber')" title="Ámbar"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffebee, #ffcdd2)" onclick="setColor('c-red')" title="Rojo"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fce4ec, #f8bbd0)" onclick="setColor('c-pink')" title="Rosa"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7)" onclick="setColor('c-purple')" title="Púrpura"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9)" onclick="setColor('c-indigo')" title="Índigo"></div>

        <div class="swatch" style="background: linear-gradient(135deg, #ede7f6, #d1c4e9)" onclick="setColor('c-lavender')" title="Lavanda"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #efebe9, #d7ccc8)" onclick="setColor('c-brown')" title="Café"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #37474f, #263238)" onclick="setColor('c-dark')" title="Oscuro"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffffff, #f5f5f5)" onclick="setColor('c-gray')" title="Neutro"></div>
    </div>

    <script>
        const BIN_ID = '696a7f22ae596e708fe10d1b';
        const MASTER_KEY = '$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm';

        let isEditing = false;
        let activeCardId = null;
        let dragSrcEl = null;
        // LISTA DE COLORES ACTUALIZADA (14 Colores)
        const colorClasses = [
            'c-blue', 'c-green', 'c-purple', 'c-orange', 'c-red', 'c-dark', 'c-gray',
            'c-teal', 'c-pink', 'c-indigo', 'c-lime', 'c-amber', 'c-brown', 'c-lavender'
        ];

        // --- LED STATUS ---
        function setStatus(state) {
            const led = document.getElementById('statusLed');
            const label = document.getElementById('statusLabel');
            const cloudBtn = document.getElementById('cloudBtn');
            const cloudText = document.getElementById('cloudText');

            led.classList.remove('online', 'offline', 'syncing');
            cloudBtn.classList.remove('saving');

            if (state === 'online') {
                led.classList.add('online'); label.innerText = 'En Línea'; label.style.color = '#27ae60';
                cloudText.innerText = 'Nube OK';
            } else if (state === 'syncing') {
                led.classList.add('syncing'); label.innerText = 'Conectando...'; label.style.color = '#f1c40f';
                cloudText.innerText = 'Guardando...'; cloudBtn.classList.add('saving');
            } else if (state === 'offline') {
                led.classList.add('offline'); label.innerText = 'Sin Conexión'; label.style.color = '#e74c3c';
                cloudText.innerText = 'Error';
            }
        }
        window.addEventListener('online', () => setStatus('online'));
        window.addEventListener('offline', () => setStatus('offline'));

        // --- TECLADO ---
        window.addEventListener('keydown', (e) => {
            const searchInput = document.getElementById('searchInput');
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') { 
                e.preventDefault(); searchInput.focus(); searchInput.select();
            }
            if (e.key === 'Escape' && document.activeElement === searchInput) {
                e.preventDefault();
                searchInput.value = ''; 
                filterCards();
            }
        });

        // --- AUTO-SYNC (NUBE AUTOMÁTICA) ---
        async function syncToCloud() {
            const cloudIcon = document.querySelector('.cloud-icon');
            setStatus('syncing');
            cloudIcon.classList.add('spinning');

            const data = {};
            document.querySelectorAll('.card').forEach(card => {
                data[card.id] = {
                    txt: card.querySelector('.card-content').innerText,
                    col: colorClasses.find(c => card.classList.contains(c))
                };
            });

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                    body: JSON.stringify(data)
                });
                if (response.ok) { 
                    setTimeout(() => { 
                        setStatus('online'); 
                        cloudIcon.classList.remove('spinning');
                        showToast("✅ Guardado Automático");
                    }, 500);
                } else throw new Error();
            } catch (err) { 
                setStatus('offline'); 
                cloudIcon.classList.remove('spinning');
            } 
        }

        async function loadFromCloud() {
            setStatus('syncing');
            try {
                await new Promise(r => setTimeout(r, 400)); 
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                const result = await response.json();
                const data = result.record;

                if(data.estado === "listo") { setStatus('online'); return; }

                Object.keys(data).forEach(id => {
                    const card = document.getElementById(id);
                    if(card) {
                        card.querySelector('.card-content').innerText = data[id].txt;
                        colorClasses.forEach(c => card.classList.remove(c));
                        card.classList.add(data[id].col);
                    }
                });
                setStatus('online');
            } catch (err) { setStatus('offline'); }
        }

        window.onload = () => {
            document.querySelectorAll('.card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.03}s`;
                const btn = document.createElement('div');
                btn.className = 'settings-btn'; btn.innerHTML = '⚙️';
                btn.onclick = (e) => { e.stopPropagation(); openColorMenu(e, card.id); };
                card.appendChild(btn);
                addDnDHandlers(card);
                card.addEventListener('click', (e) => handleCardClick(e, card));
            });
            loadFromCloud();
        };

        // --- CORE FUNCTIONS ---
        function handleCardClick(e, card) {
            if(isEditing || e.target.closest('.settings-btn')) return;
            
            const circle = document.createElement("span");
            const diameter = Math.max(card.clientWidth, card.clientHeight);
            const radius = diameter / 2;
            const rect = card.getBoundingClientRect();
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.clientX - rect.left - radius}px`;
            circle.style.top = `${e.clientY - rect.top - radius}px`;
            circle.classList.add("ripple");
            const existing = card.getElementsByClassName("ripple")[0];
            if (existing) existing.remove();
            card.appendChild(circle);

            navigator.clipboard.writeText(card.querySelector('.card-content').innerText).then(() => showToast("Copiado al portapapeles"));
        }

        function filterCards() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                const txt = c.querySelector('.card-content').innerText.toLowerCase();
                c.classList.toggle('dimmed', q && !txt.includes(q));
            });
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            const btnText = document.getElementById('btnText');
            const editBtn = document.getElementById('editBtn');
            
            if(!isEditing) {
                syncToCloud();
            }

            document.querySelectorAll('.card').forEach(c => {
                c.classList.toggle('editing', isEditing);
                c.setAttribute('draggable', !isEditing);
                c.querySelector('.card-content').contentEditable = isEditing;
            });
            btnText.innerText = isEditing ? "Editando..." : "Bloqueado";
            editBtn.classList.toggle('active', isEditing);
        }

        function openColorMenu(e, id) {
            activeCardId = id; const menu = document.getElementById('colorMenu');
            menu.style.display = 'grid'; 
            let x = e.clientX + 10; let y = e.clientY + 10;
            if (x + 250 > window.innerWidth) x = e.clientX - 260;
            if (y + 200 > window.innerHeight) y = e.clientY - 210;
            menu.style.left = x + 'px'; menu.style.top = y + 'px';
            document.getElementById('overlay').style.display = 'block';
        }
        function setColor(cls) {
            const card = document.getElementById(activeCardId);
            colorClasses.forEach(c => card.classList.remove(c));
            card.classList.add(cls); 
            closeColorMenu();
            syncToCloud();
        }
        function closeColorMenu() { document.getElementById('colorMenu').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            t.querySelector('span').innerText = msg; t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 2000); 
        }

        // --- DND & SWAP ---
        function addDnDHandlers(card) {
            card.addEventListener('dragstart', function(e) { 
                if(isEditing) { e.preventDefault(); return; } 
                dragSrcEl = this; 
                this.classList.add('dragging'); 
                e.dataTransfer.effectAllowed = 'move';
            });
            
            card.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
            card.addEventListener('dragenter', function() { if(this !== dragSrcEl) this.classList.add('drag-target'); });
            card.addEventListener('dragleave', function() { this.classList.remove('drag-target'); });
            
            card.addEventListener('drop', function(e) {
                e.stopPropagation();
                this.classList.remove('drag-target');
                
                if (dragSrcEl !== this) {
                    const target = this;
                    const source = dragSrcEl;
                    
                    source.classList.add('swapping');
                    target.classList.add('swapping');

                    setTimeout(() => {
                        const txtA = source.querySelector('.card-content').innerText;
                        const colA = colorClasses.find(c => source.classList.contains(c));
                        const txtB = target.querySelector('.card-content').innerText;
                        const colB = colorClasses.find(c => target.classList.contains(c));
                        
                        source.querySelector('.card-content').innerText = txtB;
                        source.classList.remove(...colorClasses); source.classList.add(colB);
                        
                        target.querySelector('.card-content').innerText = txtA;
                        target.classList.remove(...colorClasses); target.classList.add(colA);

                        syncToCloud();

                    }, 160);

                    setTimeout(() => {
                        source.classList.remove('swapping');
                        target.classList.remove('swapping');
                    }, 400);
                }
                return false;
            });
            
            card.addEventListener('dragend', function() { 
                this.classList.remove('dragging'); 
                document.querySelectorAll('.card').forEach(c => c.classList.remove('drag-target')); 
            });
        }
    </script>
</body>
</html>
