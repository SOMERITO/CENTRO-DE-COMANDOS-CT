<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control - Final V10</title>
    <style>
        /* --- ESTILOS VISUALES PRO --- */
        :root {
            --bg-app: #f0f2f5; --bg-panel: #ffffff; --text-main: #1c1e21;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-hover: 0 12px 24px rgba(0,0,0,0.15);
            --radius: 12px; 
            --accent: #2980b9; --font-stack: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; font-family: var(--font-stack); background-color: var(--bg-app); 
            color: var(--text-main); height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* ANIMACIONES */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes swapPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.9); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulse-led {
            0% { transform: scale(0.95); opacity: 0.7; box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); }
            70% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 6px rgba(241, 196, 15, 0); }
            100% { transform: scale(0.95); opacity: 0.7; box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

        /* BARRA SUPERIOR */
        .toolbar { 
            flex: 0 0 auto; display: flex; gap: 15px; align-items: center; 
            padding: 12px 25px; background: var(--bg-panel); 
            border-bottom: 1px solid rgba(0,0,0,0.08); z-index: 100;
            animation: fadeInUp 0.4s ease-out;
        }
        .brand { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: -0.5px; }
        .brand span { color: var(--accent); }

        .search-box { flex: 1; position: relative; max-width: 450px; }
        .search-box input { 
            width: 100%; padding: 10px 15px 10px 40px; border-radius: 25px; 
            border: 1px solid #dce0e5; background: var(--bg-app); color: var(--text-main); 
            font-size: 0.9rem; transition: all 0.3s;
        }
        .search-box input:focus { border-color: var(--accent); background: var(--bg-panel); box-shadow: 0 4px 12px rgba(41, 128, 185, 0.15); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.5; width: 16px; }
        .search-tip { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--accent); opacity: 0.7; pointer-events: none; font-weight: 600; }

        .actions { display: flex; gap: 12px; margin-left: auto; align-items: center; }
        
        /* LED STATUS & BOTONES */
        .status-container { display: flex; align-items: center; gap: 8px; margin-right: 5px; padding: 6px 12px; background: #f8f9fa; border-radius: 20px; border: 1px solid #e9ecef; }
        .status-led { width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; transition: all 0.3s ease; }
        .status-text { font-size: 0.7rem; font-weight: 600; color: #7f8c8d; transition: color 0.3s; white-space: nowrap; }

        .status-led.online { background-color: #2ecc71; box-shadow: 0 0 6px #2ecc71; }
        .status-led.offline { background-color: #e74c3c; box-shadow: 0 0 6px #e74c3c; }
        .status-led.syncing { background-color: #f1c40f; animation: pulse-led 1.5s infinite; }

        .btn { padding: 9px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s; border: 1px solid transparent; }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        
        .btn-cloud { background: linear-gradient(to bottom, #ffffff, #f8f9fa); color: #495057; border-color: #dce0e5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } 
        .btn-cloud:hover { background: linear-gradient(to bottom, #f8f9fa, #e9ecef); border-color: #cdd4da; }
        .btn-cloud.saving { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .cloud-icon.spinning { animation: spin 1s linear infinite; display: inline-block; }

        .btn-primary { background: linear-gradient(135deg, var(--accent), #1f6391); color: white; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-primary.active { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-backup { background: #6c757d; color: white; }

        /* GRID */
        .dashboard-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(6, 1fr); grid-auto-rows: minmax(110px, auto); gap: 15px; overflow-y: auto; padding-bottom: 40px; }

        .card { position: relative; border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow-card); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; user-select: none; overflow: hidden; border: 1px solid rgba(255,255,255,0.5); background: var(--bg-panel); opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        
        /* Retrasos de entrada */
        .card:nth-child(1) { animation-delay: 0.05s; } .card:nth-child(2) { animation-delay: 0.07s; }
        .card:nth-child(3) { animation-delay: 0.09s; } .card:nth-child(4) { animation-delay: 0.11s; }
        .card:nth-child(5) { animation-delay: 0.13s; } .card:nth-child(6) { animation-delay: 0.15s; }
        /* ... se aplica din谩micamente ... */

        .card:hover:not(.editing) { transform: translateY(-6px) scale(1.02); box-shadow: var(--shadow-hover); z-index: 10; }
        .card.dragging { opacity: 0.4; transform: scale(0.9); border: 2px dashed #999; }
        .card.drag-target { transform: scale(1.05); box-shadow: 0 0 0 3px var(--accent); z-index: 20; }
        .card.swapping { animation: swapPulse 0.4s ease-in-out forwards; }

        .card-content { 
            font-size: 0.75rem; line-height: 1.4; font-weight: 600; 
            color: inherit; /* CONTRASTE AUTOMTICO */
            height: 100%; pointer-events: none; white-space: pre-wrap; transition: opacity 0.3s;
        }
        .card.dimmed { opacity: 0.08; transform: scale(0.95); filter: grayscale(1) blur(1px); pointer-events: none; }
        
        .card.editing { cursor: text; border: 2px dashed #bdc3c7 !important; background: #f9f9f9 !important; color: #000 !important; transform: none !important; }
        .card.editing .card-content { pointer-events: auto; opacity: 1; color: #000; }
        
        .settings-btn { position: absolute; bottom: 8px; right: 8px; cursor: pointer; display: none; background: white; border-radius: 50%; width: 24px; height: 24px; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; }
        .card.editing .settings-btn { display: flex; animation: popIn 0.3s; }

        /* PALETA DE COLORES */
        .c-blue { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #0d47a1; }
        .c-green { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #1b5e20; }
        .c-purple { background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #4a148c; }
        .c-orange { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #e65100; }
        .c-red { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: #b71c1c; }
        .c-gray { background: linear-gradient(135deg, #ffffff, #f5f5f5); color: #455a64; }
        .c-teal { background: linear-gradient(135deg, #e0f2f1, #b2dfdb); color: #00695c; }
        .c-pink { background: linear-gradient(135deg, #fce4ec, #f8bbd0); color: #880e4f; }
        .c-indigo { background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #283593; }
        .c-lime { background: linear-gradient(135deg, #f9fbe7, #dcedc8); color: #558b2f; }
        .c-amber { background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ff6f00; }
        .c-brown { background: linear-gradient(135deg, #efebe9, #d7ccc8); color: #4e342e; }
        .c-lavender { background: linear-gradient(135deg, #ede7f6, #d1c4e9); color: #512da8; }
        
        /* COLORES OSCUROS (Texto Blanco) */
        .c-dark { background: linear-gradient(135deg, #37474f, #212121); color: #ffffff !important; }
        .c-purple-dark { background: linear-gradient(135deg, #4a148c, #311b92); color: #ffffff !important; }

        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple 0.6s linear; background-color: rgba(0, 0, 0, 0.05); pointer-events: none; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px); background: #2d3436; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); opacity: 0; transition: all 0.4s; z-index: 300; pointer-events: none; display: flex; align-items: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        #colorMenu { display: none; position: fixed; z-index: 200; background: var(--bg-panel); padding: 18px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); grid-template-columns: repeat(5, 1fr); gap: 12px; border: 1px solid rgba(0,0,0,0.05); animation: popIn 0.3s; }
        .swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .swatch:hover { transform: scale(1.15); }
    </style>
</head>
<body>

    <header class="toolbar">
        <div class="brand">Control<span>PRO</span></div>
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" id="searchInput" placeholder="Filtrar respuestas..." oninput="filterCards()">
            <span class="search-tip">Ctrl + F / ESC</span>
        </div>
        <div class="actions">
            <div class="status-container" title="Estado de conexi贸n">
                <div id="statusLed" class="status-led"></div>
                <span id="statusLabel" class="status-text">...</span>
            </div>
            
            <button class="btn btn-backup" onclick="downloadBackup()" title="Descargar copia de seguridad"></button>
            <button class="btn btn-cloud" id="cloudBtn" onclick="syncToCloud(true)" title="Forzar Sincronizaci贸n">
                <span class="cloud-icon">锔</span> <span id="cloudText">Nube OK</span>
            </button>
            <button class="btn btn-primary" id="editBtn" onclick="toggleEditMode()">
                <span id="btnText">Bloqueado</span>
            </button>
        </div>
    </header>

    <div class="dashboard-grid" id="grid">
        </div>

    <div id="toast" class="toast">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" color="#2ecc71"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span>Copiado</span>
    </div>
    <div id="overlay" style="display:none; position:fixed; inset:0; z-index:150;" onclick="closeColorMenu()"></div>
    <div id="colorMenu">
        <div class="swatch" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb)" onclick="setColor('c-blue')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb)" onclick="setColor('c-teal')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9)" onclick="setColor('c-green')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f9fbe7, #dcedc8)" onclick="setColor('c-lime')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2)" onclick="setColor('c-orange')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fff8e1, #ffecb3)" onclick="setColor('c-amber')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffebee, #ffcdd2)" onclick="setColor('c-red')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fce4ec, #f8bbd0)" onclick="setColor('c-pink')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7)" onclick="setColor('c-purple')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9)" onclick="setColor('c-indigo')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ede7f6, #d1c4e9)" onclick="setColor('c-lavender')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #efebe9, #d7ccc8)" onclick="setColor('c-brown')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #37474f, #263238)" onclick="setColor('c-dark')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #4a148c, #311b92)" onclick="setColor('c-purple-dark')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffffff, #f5f5f5)" onclick="setColor('c-gray')"></div>
    </div>

    <script>
        // --- CREDENCIALES INTEGRADAS ---
        const BIN_ID = '698dfdc1d0ea881f40b55397'; 
        const MASTER_KEY = '$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm';

        // --- DATOS DE RESPALDO (TU EXCEL) ---
        // Estos datos se usar谩n autom谩ticamente si el BIN nuevo est谩 vac铆o
        const defaultData = {
            "c01": { "txt": "Realiza seguimiento a su ticket. / Se verifica que el ticket a煤n se encuentra en proceso de evaluaci贸n por el 谩rea correspondiente. Se solicita la paciencia del caso mientras se obtiene una respuesta. Ticket a煤n no expirado:", "col": "c-blue" },
            "c02": { "txt": "Solicita respuesta a su ticket. / Se verifica que el ticket ya figura como expirado en el sistema, por lo que se procede a reportarlo con el monitor(a) correspondiente para su revisi贸n:", "col": "c-blue" },
            "c03": { "txt": "Solicita el estado de su solicitud de XXXXXXXXXX. / Se verifica y se indica que solicitud tiene el estado: XXXXXXXXXX.", "col": "c-orange" },
            "c04": { "txt": "Cuenta con consulta que requiere atenci贸n de IT Services / Se le deriva al canal de atenci贸n de IT Services para que reciba el soporte correspondiente.", "col": "c-purple" },
            "c05": { "txt": "Se solicita la evidencia del caso para poder reportarlo > Alumno menciona que enviar谩 las evidencias y que se volver谩 a contactar para proceder con el reporte del caso.", "col": "c-purple" },
            "c06": { "txt": "Se le deriva al canal de atenci贸n de WhatsApp para que pueda enviar las evidencias correspondientes, a fin de que se eval煤e la posibilidad de generar un ticket para la revisi贸n del caso.", "col": "c-dark" },
            "c07": { "txt": "Realiza seguimiento a su ticket. / Se verifica que el ticket a煤n se encuentra en proceso de evaluaci贸n por el 谩rea correspondiente. (Variante Oscura)", "col": "c-dark" },
            "c08": { "txt": "Solicita respuesta a su ticket. / Se verifica que el ticket ya figura como expirado en el sistema. (Variante Oscura)", "col": "c-dark" },
            "c09": { "txt": "Se genera un ticket CRM para la evaluaci贸n del caso por parte del 谩rea responsable.", "col": "c-dark" },
            "c10": { "txt": "Se deriva el caso a la generaci贸n de un ticket en Zendesk.", "col": "c-dark" },
            "c11": { "txt": "Estimado(a), Le agradecer茅 revisar este caso, por favor. El estudiante se comunic贸 hoy mediante llamada y se mostr贸 bastante preocupado por la situaci贸n, por lo que ser铆a de mucha ayuda poder agilizar la gesti贸n.", "col": "c-green" },
            "c12": { "txt": "Se registra por ruta elegida porque no aparece la opci贸n correcta.", "col": "c-red" },
            "c13": { "txt": "Se elige la opci贸n de SLA excedido - Zendesk debido a que no aparece la opci贸n: Seguimiento de Ticket.", "col": "c-gray" },
            "c14": { "txt": "Se tipifica por este medio, puesto que CRM presenta intermitencia.", "col": "c-purple" },
            "c15": { "txt": "No responde a consulta realizada > Se procede a culminar la comunicaci贸n.", "col": "c-red" },
            "c16": { "txt": "No contesta > Se procede a culminar la comunicaci贸n.", "col": "c-red" },
            "c17": { "txt": "No contesta > Corta llamada.", "col": "c-red" },
            "c18": { "txt": "No se aplica rellamada por alta demanda de consulta.", "col": "c-red" },
            "c19": { "txt": "NO SE DERIVA A ENCUESTA - NO APARECE LA OPCIN - NO ENCUESTA", "col": "c-purple-dark" },
            "c20": { "txt": "NO SE DERIVA A ENCUESTA - AL CORTA LLAMADA", "col": "c-purple-dark" },
            "c21": { "txt": "NO SE DERIVA A ENCUESTA - AL MOLEST@", "col": "c-purple-dark" },
            "c22": { "txt": "No se deriva a encuesta, porque no aparece la opci贸n.", "col": "c-gray" },
            "c23": { "txt": "No se deriva a encuesta, porque AL corta llamada.", "col": "c-gray" },
            "c24": { "txt": "No se deriva a encuesta, porque AL se encuentra molesto(a).", "col": "c-gray" }
        };

        let isEditing = false;
        let activeCardId = null;
        let dragSrcEl = null;
        let isDataLoaded = false;
        const colorClasses = ['c-blue', 'c-green', 'c-purple', 'c-orange', 'c-red', 'c-dark', 'c-gray', 'c-teal', 'c-pink', 'c-indigo', 'c-lime', 'c-amber', 'c-brown', 'c-lavender', 'c-purple-dark'];

        // --- STATUS ---
        function setStatus(state) {
            const led = document.getElementById('statusLed');
            const label = document.getElementById('statusLabel');
            const cloudBtn = document.getElementById('cloudBtn');
            const cloudText = document.getElementById('cloudText');
            led.classList.remove('online', 'offline', 'syncing');
            cloudBtn.classList.remove('saving');

            if (state === 'online') {
                led.classList.add('online'); label.innerText = 'En L铆nea'; label.style.color = '#27ae60'; cloudText.innerText = 'Nube OK';
            } else if (state === 'syncing') {
                led.classList.add('syncing'); label.innerText = 'Cargando...'; label.style.color = '#f1c40f'; cloudText.innerText = 'Guardando...'; cloudBtn.classList.add('saving');
            } else if (state === 'offline') {
                led.classList.add('offline'); label.innerText = 'Offline'; label.style.color = '#e74c3c'; cloudText.innerText = 'Error';
            }
        }
        window.addEventListener('online', () => setStatus('online'));
        window.addEventListener('offline', () => setStatus('offline'));

        // --- CARGA Y GUARDADO ---
        async function loadFromCloud() {
            setStatus('syncing');
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                
                let data = {};
                if (response.ok) {
                    const result = await response.json();
                    data = result.record;
                }

                // SI EL BIN EST VACO (NUEVO), USAMOS EL RESPALDO DEL EXCEL
                if (!data || Object.keys(data).length === 0) {
                    console.log("Detectado BIN nuevo. Restaurando datos del Excel...");
                    data = defaultData;
                    // Y guardamos inmediatamente para inicializar la nube
                    isDataLoaded = true; // Permitir guardado
                    setTimeout(() => syncToCloud(true), 1000);
                }

                // RENDERIZAR
                const grid = document.getElementById('grid');
                grid.innerHTML = ''; // Limpiar
                
                // Asegurar que haya al menos 24 casillas, mezclando datos con vac铆os si hace falta
                const totalCards = Math.max(24, Object.keys(data).length);
                
                for(let i=1; i<=totalCards; i++) {
                    const id = `c${i<10?'0'+i:i}`;
                    const cardData = data[id] || { txt: "...", col: "c-gray" };
                    
                    const div = document.createElement('div');
                    div.className = `card ${cardData.col}`;
                    div.id = id;
                    div.draggable = true;
                    div.style.animationDelay = `${i * 0.02}s`;
                    div.innerHTML = `
                        <div class="card-content">${cardData.txt}</div>
                        <div class="settings-btn" onclick="event.stopPropagation(); openColorMenu(event, '${id}')">锔</div>
                    `;
                    
                    div.addEventListener('click', (e) => handleCardClick(e, div));
                    addDnDHandlers(div);
                    grid.appendChild(div);
                }

                isDataLoaded = true;
                setStatus('online');

            } catch (err) { 
                console.error(err);
                setStatus('offline');
                // Si falla la conexi贸n inicial, cargar respaldo local visualmente al menos
                alert("Error de conexi贸n. Se cargar谩n los datos locales de respaldo.");
                isDataLoaded = true; // Permitimos trabajar offline
                // Aqu铆 podr铆as llamar a una funci贸n para renderizar defaultData igual que arriba
            }
        }

        async function syncToCloud(force = false) {
            if (!isDataLoaded && !force) return; // Protecci贸n contra sobrescritura

            const cloudIcon = document.querySelector('.cloud-icon');
            setStatus('syncing');
            cloudIcon.classList.add('spinning');

            const data = {};
            document.querySelectorAll('.card').forEach(card => {
                data[card.id] = {
                    txt: card.querySelector('.card-content').innerText,
                    col: colorClasses.find(c => card.classList.contains(c)) || 'c-gray'
                };
            });

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                    body: JSON.stringify(data)
                });
                if (response.ok) { 
                    setTimeout(() => { setStatus('online'); cloudIcon.classList.remove('spinning'); }, 500);
                } else throw new Error();
            } catch (err) { 
                setStatus('offline'); cloudIcon.classList.remove('spinning');
            }
        }

        function downloadBackup() {
            const data = {};
            document.querySelectorAll('.card').forEach(card => {
                data[card.id] = {
                    txt: card.querySelector('.card-content').innerText,
                    col: colorClasses.find(c => card.classList.contains(c))
                };
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "control_pro_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.onload = loadFromCloud;

        // --- FUNCIONES UI ---
        function handleCardClick(e, card) {
            if(isEditing || e.target.closest('.settings-btn')) return;
            const circle = document.createElement("span");
            const d = Math.max(card.clientWidth, card.clientHeight);
            circle.style.width = circle.style.height = `${d}px`;
            circle.style.left = `${e.clientX - card.getBoundingClientRect().left - d/2}px`;
            circle.style.top = `${e.clientY - card.getBoundingClientRect().top - d/2}px`;
            circle.classList.add("ripple");
            card.appendChild(circle);
            setTimeout(()=>circle.remove(), 600);
            navigator.clipboard.writeText(card.querySelector('.card-content').innerText).then(() => showToast("Copiado"));
        }

        function filterCards() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                const txt = c.querySelector('.card-content').innerText.toLowerCase();
                c.classList.toggle('dimmed', q && !txt.includes(q));
            });
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            const btnText = document.getElementById('btnText');
            const editBtn = document.getElementById('editBtn');
            if(!isEditing) { syncToCloud(); }
            document.querySelectorAll('.card').forEach(c => {
                c.classList.toggle('editing', isEditing);
                c.setAttribute('draggable', !isEditing);
                c.querySelector('.card-content').contentEditable = isEditing;
            });
            btnText.innerText = isEditing ? "Editando..." : "Bloqueado";
            editBtn.classList.toggle('active', isEditing);
        }

        function openColorMenu(e, id) {
            activeCardId = id; const menu = document.getElementById('colorMenu');
            menu.style.display = 'grid'; 
            let x = e.clientX + 10; let y = e.clientY + 10;
            if (x + 250 > window.innerWidth) x = e.clientX - 260;
            if (y + 100 > window.innerHeight) y = e.clientY - 110;
            menu.style.left = x + 'px'; menu.style.top = y + 'px';
            document.getElementById('overlay').style.display = 'block';
        }
        function setColor(cls) {
            const card = document.getElementById(activeCardId);
            colorClasses.forEach(c => card.classList.remove(c));
            card.classList.add(cls); closeColorMenu(); syncToCloud();
        }
        function closeColorMenu() { document.getElementById('colorMenu').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        function showToast(msg) { const t = document.getElementById('toast'); t.querySelector('span') ? t.querySelector('span').innerText = msg : t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        function addDnDHandlers(card) {
            card.addEventListener('dragstart', function(e) { if(isEditing) { e.preventDefault(); return; } dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
            card.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
            card.addEventListener('dragenter', function() { if(this !== dragSrcEl) this.classList.add('drag-target'); });
            card.addEventListener('dragleave', function() { this.classList.remove('drag-target'); });
            card.addEventListener('drop', function(e) {
                e.stopPropagation(); this.classList.remove('drag-target');
                if (dragSrcEl !== this) {
                    const target = this; const source = dragSrcEl;
                    source.classList.add('swapping'); target.classList.add('swapping');
                    setTimeout(() => {
                        const txtA = source.querySelector('.card-content').innerText;
                        const colA = colorClasses.find(c => source.classList.contains(c));
                        const txtB = target.querySelector('.card-content').innerText;
                        const colB = colorClasses.find(c => target.classList.contains(c));
                        source.querySelector('.card-content').innerText = txtB;
                        source.classList.remove(...colorClasses); source.classList.add(colB);
                        target.querySelector('.card-content').innerText = txtA;
                        target.classList.remove(...colorClasses); target.classList.add(colA);
                        syncToCloud();
                    }, 200);
                    setTimeout(() => { source.classList.remove('swapping'); target.classList.remove('swapping'); }, 400);
                }
                return false;
            });
            card.addEventListener('dragend', function() { this.classList.remove('dragging'); document.querySelectorAll('.card').forEach(c => c.classList.remove('drag-target')); });
        }
        
        window.addEventListener('keydown', (e) => { 
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
            if (e.key === 'Escape') { document.getElementById('searchInput').value=''; filterCards(); }
        });
    </script>
</body>
</html>
