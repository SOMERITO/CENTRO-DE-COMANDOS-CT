<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Control - Manual V11</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-app: #f0f2f5; --bg-panel: #ffffff; --text-main: #1c1e21;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-hover: 0 12px 24px rgba(0,0,0,0.15);
            --radius: 12px; 
            --accent: #2980b9; --font-stack: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; font-family: var(--font-stack); background-color: var(--bg-app); 
            color: var(--text-main); height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* ANIMACIONES */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes modalIn { 
            0% { opacity: 0; transform: scale(0.95) translateY(10px); } 
            100% { opacity: 1; transform: scale(1) translateY(0); } 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BARRA SUPERIOR */
        .toolbar { 
            flex: 0 0 auto; display: flex; gap: 15px; align-items: center; 
            padding: 12px 25px; background: var(--bg-panel); 
            border-bottom: 1px solid rgba(0,0,0,0.08); z-index: 100;
            animation: fadeInUp 0.4s ease-out;
        }
        .brand { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: -0.5px; }
        .brand span { color: var(--accent); }

        .search-box { flex: 1; position: relative; max-width: 450px; }
        .search-box input { 
            width: 100%; padding: 10px 15px 10px 40px; border-radius: 25px; 
            border: 1px solid #dce0e5; background: var(--bg-app); color: var(--text-main); 
            font-size: 0.9rem; transition: all 0.3s;
        }
        .search-box input:focus { border-color: var(--accent); background: var(--bg-panel); box-shadow: 0 4px 12px rgba(41, 128, 185, 0.15); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.5; width: 16px; }
        .search-tip { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: var(--accent); opacity: 0.7; pointer-events: none; font-weight: 600; }

        .actions { display: flex; gap: 12px; margin-left: auto; align-items: center; }
        
        /* LED STATUS */
        .status-container { display: flex; align-items: center; gap: 8px; margin-right: 5px; padding: 6px 12px; background: #f8f9fa; border-radius: 20px; border: 1px solid #e9ecef; }
        .status-led { width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; transition: all 0.3s ease; }
        .status-text { font-size: 0.7rem; font-weight: 600; color: #7f8c8d; transition: color 0.3s; white-space: nowrap; }

        .status-led.online { background-color: #2ecc71; box-shadow: 0 0 6px #2ecc71; }
        .status-led.offline { background-color: #e74c3c; box-shadow: 0 0 6px #e74c3c; }
        .status-led.syncing { background-color: #f1c40f; }
        .status-led.unsaved { background-color: #e67e22; box-shadow: 0 0 6px #e67e22; } /* Nuevo estado */

        /* BOTONES */
        .btn { padding: 9px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s; border: 1px solid transparent; }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        
        .btn-cloud { background: linear-gradient(to bottom, #ffffff, #f8f9fa); color: #495057; border-color: #dce0e5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); } 
        .btn-cloud:hover { background: linear-gradient(to bottom, #f8f9fa, #e9ecef); border-color: #cdd4da; }
        
        .btn-primary { background: linear-gradient(135deg, var(--accent), #1f6391); color: white; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-primary.active { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-backup { background: #6c757d; color: white; }

        /* GRID */
        .dashboard-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(6, 1fr); grid-auto-rows: minmax(110px, auto); gap: 15px; overflow-y: auto; padding-bottom: 40px; }

        .card { position: relative; border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow-card); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; user-select: none; overflow: hidden; border: 1px solid rgba(255,255,255,0.5); background: var(--bg-panel); opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        .card:hover:not(.editing) { transform: translateY(-6px) scale(1.02); box-shadow: var(--shadow-hover); z-index: 10; }
        
        /* Contenido con contraste autom√°tico */
        .card-content { font-size: 0.75rem; line-height: 1.4; font-weight: 600; color: inherit; height: 100%; pointer-events: none; white-space: pre-wrap; transition: opacity 0.3s; }
        .card.dimmed { opacity: 0.08; transform: scale(0.95); filter: grayscale(1) blur(1px); pointer-events: none; }
        
        .card.editing { cursor: text; border: 2px dashed #bdc3c7 !important; background: #f9f9f9 !important; color: #000 !important; transform: none !important; }
        .card.editing .card-content { pointer-events: auto; opacity: 1; color: #000; }
        
        .settings-btn { position: absolute; bottom: 8px; right: 8px; cursor: pointer; display: none; background: white; border-radius: 50%; width: 24px; height: 24px; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; }
        .card.editing .settings-btn { display: flex; animation: popIn 0.3s; }

        /* COLORES */
        .c-blue { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #0d47a1; }
        .c-green { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #1b5e20; }
        .c-purple { background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #4a148c; }
        .c-orange { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #e65100; }
        .c-red { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: #b71c1c; }
        .c-gray { background: linear-gradient(135deg, #ffffff, #f5f5f5); color: #455a64; }
        .c-teal { background: linear-gradient(135deg, #e0f2f1, #b2dfdb); color: #00695c; }
        .c-pink { background: linear-gradient(135deg, #fce4ec, #f8bbd0); color: #880e4f; }
        .c-indigo { background: linear-gradient(135deg, #e8eaf6, #c5cae9); color: #283593; }
        .c-lime { background: linear-gradient(135deg, #f9fbe7, #dcedc8); color: #558b2f; }
        .c-amber { background: linear-gradient(135deg, #fff8e1, #ffecb3); color: #ff6f00; }
        .c-brown { background: linear-gradient(135deg, #efebe9, #d7ccc8); color: #4e342e; }
        .c-lavender { background: linear-gradient(135deg, #ede7f6, #d1c4e9); color: #512da8; }
        .c-dark { background: linear-gradient(135deg, #37474f, #212121); color: #ffffff !important; }
        .c-purple-dark { background: linear-gradient(135deg, #4a148c, #311b92); color: #ffffff !important; }

        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple 0.6s linear; background-color: rgba(0, 0, 0, 0.05); pointer-events: none; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px); background: #2d3436; color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); opacity: 0; transition: all 0.4s; z-index: 300; pointer-events: none; display: flex; align-items: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        #colorMenu { display: none; position: fixed; z-index: 200; background: var(--bg-panel); padding: 18px; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); grid-template-columns: repeat(5, 1fr); gap: 12px; border: 1px solid rgba(0,0,0,0.05); animation: popIn 0.3s; }
        .swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .swatch:hover { transform: scale(1.15); }

        /* --- NUEVO: MODAL DE CONFIRMACI√ìN --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 1000;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-box {
            background: white; padding: 30px; width: 400px; max-width: 90%;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            text-align: center;
            border: 1px solid rgba(0,0,0,0.05);
            transform: scale(0.95); opacity: 0;
            animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: #2c3e50; margin: 0 0 10px 0; }
        .modal-desc { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        
        .btn-cancel { background: #f1f2f6; color: #636e72; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-cancel:hover { background: #dfe4ea; }
        
        .btn-confirm { background: #2980b9; color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .btn-confirm:hover { background: #21618c; transform: translateY(-2px); }

    </style>
</head>
<body>

    <header class="toolbar">
        <div class="brand">Control<span>PRO</span></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Filtrar respuestas..." oninput="filterCards()">
            <span class="search-tip">Ctrl + F / ESC</span>
        </div>
        <div class="actions">
            <div class="status-container" title="Estado de conexi√≥n">
                <div id="statusLed" class="status-led"></div>
                <span id="statusLabel" class="status-text">...</span>
            </div>
            
            <button class="btn btn-backup" onclick="downloadBackup()" title="Descargar copia de seguridad">üíæ</button>
            
            <button class="btn btn-cloud" id="cloudBtn" onclick="openSaveModal()" title="Guardar Cambios">
                <span class="cloud-icon">‚òÅÔ∏è</span> <span id="cloudText">Guardar</span>
            </button>
            
            <button class="btn btn-primary" id="editBtn" onclick="toggleEditMode()">
                <span id="btnText">Bloqueado</span>
            </button>
        </div>
    </header>

    <div class="dashboard-grid" id="grid"></div>

    <div id="toast" class="toast"><span>Notificaci√≥n</span></div>
    
    <div id="overlay" style="display:none; position:fixed; inset:0; z-index:150;" onclick="closeColorMenu()"></div>
    <div id="colorMenu">
        <div class="swatch" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb)" onclick="setColor('c-blue')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e0f2f1, #b2dfdb)" onclick="setColor('c-teal')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9)" onclick="setColor('c-green')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f9fbe7, #dcedc8)" onclick="setColor('c-lime')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2)" onclick="setColor('c-orange')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fff8e1, #ffecb3)" onclick="setColor('c-amber')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffebee, #ffcdd2)" onclick="setColor('c-red')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #fce4ec, #f8bbd0)" onclick="setColor('c-pink')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7)" onclick="setColor('c-purple')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #e8eaf6, #c5cae9)" onclick="setColor('c-indigo')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ede7f6, #d1c4e9)" onclick="setColor('c-lavender')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #efebe9, #d7ccc8)" onclick="setColor('c-brown')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #37474f, #263238)" onclick="setColor('c-dark')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #4a148c, #311b92)" onclick="setColor('c-purple-dark')"></div>
        <div class="swatch" style="background: linear-gradient(135deg, #ffffff, #f5f5f5)" onclick="setColor('c-gray')"></div>
    </div>

    <div id="saveModal" class="modal-overlay">
        <div class="modal-box">
            <span class="modal-icon">‚òÅÔ∏è</span>
            <h3 class="modal-title">¬øGuardar cambios en la nube?</h3>
            <p class="modal-desc">Se actualizar√° la informaci√≥n para todos tus dispositivos. Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSaveModal()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmSave()">S√≠, Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const BIN_ID = '698dfdc1d0ea881f40b55397'; 
        const MASTER_KEY = '$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm';

        const defaultData = {
            "c01": { "txt": "Realiza seguimiento a su ticket. / Se verifica que el ticket a√∫n se encuentra en proceso de evaluaci√≥n por el √°rea correspondiente. Se solicita la paciencia del caso mientras se obtiene una respuesta. Ticket a√∫n no expirado:", "col": "c-blue" },
            "c02": { "txt": "Solicita respuesta a su ticket. / Se verifica que el ticket ya figura como expirado en el sistema, por lo que se procede a reportarlo con el monitor(a) correspondiente para su revisi√≥n:", "col": "c-blue" },
            "c03": { "txt": "Solicita el estado de su solicitud de XXXXXXXXXX. / Se verifica y se indica que solicitud tiene el estado: XXXXXXXXXX.", "col": "c-orange" },
            "c04": { "txt": "Cuenta con consulta que requiere atenci√≥n de IT Services / Se le deriva al canal de atenci√≥n de IT Services para que reciba el soporte correspondiente.", "col": "c-purple" },
            "c05": { "txt": "Se solicita la evidencia del caso para poder reportarlo > Alumno menciona que enviar√° las evidencias y que se volver√° a contactar para proceder con el reporte del caso.", "col": "c-purple" },
            "c06": { "txt": "Se le deriva al canal de atenci√≥n de WhatsApp para que pueda enviar las evidencias correspondientes, a fin de que se eval√∫e la posibilidad de generar un ticket para la revisi√≥n del caso.", "col": "c-dark" },
            "c07": { "txt": "Realiza seguimiento a su ticket. / Se verifica que el ticket a√∫n se encuentra en proceso de evaluaci√≥n por el √°rea correspondiente. (Variante Oscura)", "col": "c-dark" },
            "c08": { "txt": "Solicita respuesta a su ticket. / Se verifica que el ticket ya figura como expirado en el sistema. (Variante Oscura)", "col": "c-dark" },
            "c09": { "txt": "Se genera un ticket CRM para la evaluaci√≥n del caso por parte del √°rea responsable.", "col": "c-dark" },
            "c10": { "txt": "Se deriva el caso a la generaci√≥n de un ticket en Zendesk.", "col": "c-dark" },
            "c11": { "txt": "Estimado(a), Le agradecer√© revisar este caso, por favor. El estudiante se comunic√≥ hoy mediante llamada y se mostr√≥ bastante preocupado por la situaci√≥n, por lo que ser√≠a de mucha ayuda poder agilizar la gesti√≥n.", "col": "c-green" },
            "c12": { "txt": "Se registra por ruta elegida porque no aparece la opci√≥n correcta.", "col": "c-red" },
            "c13": { "txt": "Se elige la opci√≥n de SLA excedido - Zendesk debido a que no aparece la opci√≥n: Seguimiento de Ticket.", "col": "c-gray" },
            "c14": { "txt": "Se tipifica por este medio, puesto que CRM presenta intermitencia.", "col": "c-purple" },
            "c15": { "txt": "No responde a consulta realizada > Se procede a culminar la comunicaci√≥n.", "col": "c-red" },
            "c16": { "txt": "No contesta > Se procede a culminar la comunicaci√≥n.", "col": "c-red" },
            "c17": { "txt": "No contesta > Corta llamada.", "col": "c-red" },
            "c18": { "txt": "No se aplica rellamada por alta demanda de consulta.", "col": "c-red" },
            "c19": { "txt": "NO SE DERIVA A ENCUESTA - NO APARECE LA OPCI√ìN - NO ENCUESTA", "col": "c-purple-dark" },
            "c20": { "txt": "NO SE DERIVA A ENCUESTA - AL CORTA LLAMADA", "col": "c-purple-dark" },
            "c21": { "txt": "NO SE DERIVA A ENCUESTA - AL MOLEST@", "col": "c-purple-dark" },
            "c22": { "txt": "No se deriva a encuesta, porque no aparece la opci√≥n.", "col": "c-gray" },
            "c23": { "txt": "No se deriva a encuesta, porque AL corta llamada.", "col": "c-gray" },
            "c24": { "txt": "No se deriva a encuesta, porque AL se encuentra molesto(a).", "col": "c-gray" }
        };

        let isEditing = false;
        let activeCardId = null;
        let dragSrcEl = null;
        let isDataLoaded = false;
        let hasUnsavedChanges = false;
        const colorClasses = ['c-blue', 'c-green', 'c-purple', 'c-orange', 'c-red', 'c-dark', 'c-gray', 'c-teal', 'c-pink', 'c-indigo', 'c-lime', 'c-amber', 'c-brown', 'c-lavender', 'c-purple-dark'];

        // --- MANEJO DEL MODAL ---
        function openSaveModal() {
            document.getElementById('saveModal').style.display = 'flex';
        }
        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }
        function confirmSave() {
            closeSaveModal();
            syncToCloud(true);
        }

        // --- STATUS ---
        function setStatus(state) {
            const led = document.getElementById('statusLed');
            const label = document.getElementById('statusLabel');
            led.className = 'status-led ' + state;
            
            if (state === 'online') { label.innerText = 'Sincronizado'; label.style.color = '#2ecc71'; }
            else if (state === 'syncing') { label.innerText = 'Conectando...'; label.style.color = '#f1c40f'; }
            else if (state === 'offline') { label.innerText = 'Offline'; label.style.color = '#e74c3c'; }
            else if (state === 'unsaved') { label.innerText = 'Cambios sin guardar'; label.style.color = '#e67e22'; }
        }

        // --- MARCAR COMO NO GUARDADO ---
        function markUnsaved() {
            if(!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                setStatus('unsaved');
                document.getElementById('cloudText').innerText = "Guardar";
            }
        }

        // --- CARGA ---
        async function loadFromCloud() {
            setStatus('syncing');
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                
                let data = {};
                if (response.ok) {
                    const result = await response.json();
                    data = result.record;
                }

                if (!data || Object.keys(data).length === 0) {
                    data = defaultData;
                    isDataLoaded = true;
                    setTimeout(() => syncToCloud(true), 1000); // Guardado inicial autom√°tico solo si est√° vac√≠o
                }

                const grid = document.getElementById('grid');
                grid.innerHTML = ''; 
                
                const totalCards = Math.max(24, Object.keys(data).length);
                
                for(let i=1; i<=totalCards; i++) {
                    const id = `c${i<10?'0'+i:i}`;
                    const cardData = data[id] || { txt: "...", col: "c-gray" };
                    
                    const div = document.createElement('div');
                    div.className = `card ${cardData.col}`;
                    div.id = id;
                    div.draggable = true;
                    div.style.animationDelay = `${i * 0.02}s`;
                    div.innerHTML = `
                        <div class="card-content">${cardData.txt}</div>
                        <div class="settings-btn" onclick="event.stopPropagation(); openColorMenu(event, '${id}')">‚öôÔ∏è</div>
                    `;
                    
                    div.addEventListener('click', (e) => handleCardClick(e, div));
                    addDnDHandlers(div);
                    grid.appendChild(div);
                }

                isDataLoaded = true;
                hasUnsavedChanges = false;
                setStatus('online');

            } catch (err) { 
                console.error(err);
                setStatus('offline');
                alert("Error de conexi√≥n. Se cargar√°n los datos locales de respaldo.");
                isDataLoaded = true;
            }
        }

        // --- GUARDADO MANUAL ---
        async function syncToCloud(force = false) {
            if (!isDataLoaded && !force) return;

            setStatus('syncing');
            
            const data = {};
            document.querySelectorAll('.card').forEach(card => {
                data[card.id] = {
                    txt: card.querySelector('.card-content').innerText,
                    col: colorClasses.find(c => card.classList.contains(c)) || 'c-gray'
                };
            });

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                    body: JSON.stringify(data)
                });
                if (response.ok) { 
                    setTimeout(() => { 
                        setStatus('online'); 
                        hasUnsavedChanges = false;
                        showToast("‚úÖ Informaci√≥n Guardada");
                    }, 500);
                } else throw new Error();
            } catch (err) { 
                setStatus('offline');
                showToast("‚ùå Error al guardar");
            }
        }

        function downloadBackup() {
            const data = {};
            document.querySelectorAll('.card').forEach(card => {
                data[card.id] = {
                    txt: card.querySelector('.card-content').innerText,
                    col: colorClasses.find(c => card.classList.contains(c))
                };
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "control_backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        window.onload = loadFromCloud;

        function handleCardClick(e, card) {
            if(isEditing || e.target.closest('.settings-btn')) return;
            const circle = document.createElement("span");
            const d = Math.max(card.clientWidth, card.clientHeight);
            circle.style.width = circle.style.height = `${d}px`;
            circle.style.left = `${e.clientX - card.getBoundingClientRect().left - d/2}px`;
            circle.style.top = `${e.clientY - card.getBoundingClientRect().top - d/2}px`;
            circle.classList.add("ripple");
            card.appendChild(circle);
            setTimeout(()=>circle.remove(), 600);
            navigator.clipboard.writeText(card.querySelector('.card-content').innerText).then(() => showToast("Copiado"));
        }

        function filterCards() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                const txt = c.querySelector('.card-content').innerText.toLowerCase();
                c.classList.toggle('dimmed', q && !txt.includes(q));
            });
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            const btnText = document.getElementById('btnText');
            const editBtn = document.getElementById('editBtn');
            
            if(!isEditing) {
                // Al salir de edici√≥n, NO guardamos autom√°ticamente, solo marcamos cambio
                markUnsaved();
            }

            document.querySelectorAll('.card').forEach(c => {
                c.classList.toggle('editing', isEditing);
                c.setAttribute('draggable', !isEditing);
                c.querySelector('.card-content').contentEditable = isEditing;
            });
            btnText.innerText = isEditing ? "Editando..." : "Bloqueado";
            editBtn.classList.toggle('active', isEditing);
        }

        function openColorMenu(e, id) {
            activeCardId = id; const menu = document.getElementById('colorMenu');
            menu.style.display = 'grid'; 
            let x = e.clientX + 10; let y = e.clientY + 10;
            if (x + 250 > window.innerWidth) x = e.clientX - 260;
            if (y + 100 > window.innerHeight) y = e.clientY - 110;
            menu.style.left = x + 'px'; menu.style.top = y + 'px';
            document.getElementById('overlay').style.display = 'block';
        }
        function setColor(cls) {
            const card = document.getElementById(activeCardId);
            colorClasses.forEach(c => card.classList.remove(c));
            card.classList.add(cls); 
            closeColorMenu();
            markUnsaved(); // Marcamos cambio sin guardar
        }
        function closeColorMenu() { document.getElementById('colorMenu').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
        function showToast(msg) { const t = document.getElementById('toast'); t.querySelector('span') ? t.querySelector('span').innerText = msg : t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

        function addDnDHandlers(card) {
            card.addEventListener('dragstart', function(e) { if(isEditing) { e.preventDefault(); return; } dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
            card.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
            card.addEventListener('drop', function(e) {
                e.stopPropagation(); this.classList.remove('drag-target');
                if (dragSrcEl !== this) {
                    const target = this; const source = dragSrcEl;
                    source.classList.add('swapping'); target.classList.add('swapping');
                    setTimeout(() => {
                        const txtA = source.querySelector('.card-content').innerText;
                        const colA = colorClasses.find(c => source.classList.contains(c));
                        const txtB = target.querySelector('.card-content').innerText;
                        const colB = colorClasses.find(c => target.classList.contains(c));
                        source.querySelector('.card-content').innerText = txtB;
                        source.classList.remove(...colorClasses); source.classList.add(colB);
                        target.querySelector('.card-content').innerText = txtA;
                        target.classList.remove(...colorClasses); target.classList.add(colA);
                        markUnsaved(); // Marcamos cambio sin guardar
                    }, 200);
                    setTimeout(() => { source.classList.remove('swapping'); target.classList.remove('swapping'); }, 400);
                }
                return false;
            });
            card.addEventListener('dragend', function() { this.classList.remove('dragging'); document.querySelectorAll('.card').forEach(c => c.classList.remove('drag-target')); });
        }
        
        window.addEventListener('keydown', (e) => { 
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
            if (e.key === 'Escape') { document.getElementById('searchInput').value=''; filterCards(); }
        });
    </script>
</body>
</html>
